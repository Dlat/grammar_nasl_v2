#
# (C) Tenable Network Security, Inc.
#

include("compat.inc");

if (description)
{
  script_id(100123);
  script_version("$Revision: 1.1 $");
  script_cvs_date("$Date: 2017/05/11 20:40:30 $");

  script_cve_id("CVE-2017-1194");
  script_bugtraq_id(98142);
  script_osvdb_id(156596);
  script_xref(name:"IAVA", value:"2017-A-0138");

  script_name(english:"IBM WebSphere Application Server 7.0 < 7.0.0.45 / 8.0 < 8.0.0.14 / 8.5 < 8.5.5.12 / 9.0 < 9.0.0.4 / Liberty 17.0 < 17.0.0.2 OAuth Service Provider XSRF");
  script_summary(english:"Reads the version number from the SOAP and GIOP services.");

  script_set_attribute(attribute:"synopsis", value:
"The remote web application server is affected by a cross-site request
forgery vulnerability");
  script_set_attribute(attribute:"description", value:
"The version of IBM WebSphere Application Server running on the remote
host is 7.0 prior to 7.0.0.45, 8.0 prior to 8.0.0.14, 8.5 prior to
8.5.5.12, 9.0 prior to 9.0.0.4, or Liberty 17.0 prior to 17.0.0.2. It
is, therefore, affected by a cross-site request forgery (XSRF)
vulnerability in the OAuth service provider due to a failure to
require multiple steps, explicit confirmation, or a unique token when
performing certain sensitive actions. An unauthenticated, remote
attacker can exploit this vulnerability, by convincing a user to
follow a specially crafted link, to perform unintended actions.");
  script_set_attribute(attribute:"see_also", value:"http://www-01.ibm.com/support/docview.wss?uid=swg22001226");
  script_set_attribute(attribute:"solution", value:
"Apply IBM WebSphere Application Server version 7.0 Fix Pack 45 
(7.0.0.45) / 8.0 Fix Pack 14 (8.0.0.14) / 8.5 Fix Pack 12 (8.5.5.12) /
9.0 Fix Pack 4 (9.0.0.4) / Liberty 17.0 Fix Pack 2 (Liberty 17.0.0.2)
or later. Alternatively, apply the appropriate Interim Fixes as
recommended in the vendor advisory.");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:M/Au:N/C:P/I:P/A:P");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:L");

  script_set_attribute(attribute:"vuln_publication_date", value:"2017/04/26");
  script_set_attribute(attribute:"patch_publication_date", value:"2017/04/26");
  script_set_attribute(attribute:"plugin_publication_date", value:"2017/05/11");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:ibm:websphere_application_server");
  script_set_attribute(attribute:"potential_vulnerability", value:"true");
  script_set_attribute(attribute:"stig_severity", value:"I");
  script_end_attributes();

  script_category(ACT_GATHER_INFO);
  script_family(english:"Web Servers");

  script_copyright(english:"This script is Copyright (C) 2017 Tenable Network Security, Inc.");

  script_dependencies("websphere_detect.nasl", "websphere_liberty_detect.nbin");
  script_require_ports("Services/www", 8880, 8881, 9001);
  script_require_keys("www/WebSphere", "Settings/ParanoidReport");

  exit(0);
}

include("audit.inc");
include("global_settings.inc");
include("misc_func.inc");
include("http.inc");

if (report_paranoia < 2) audit(AUDIT_PARANOID);

port = get_http_port(default:8880, embedded:FALSE);

version = get_kb_item_or_exit("www/WebSphere/"+port+"/version");
source = get_kb_item_or_exit("www/WebSphere/"+port+"/source");

app_name = "IBM WebSphere Application Server";

if (version =~ "((^8(\.[05](\.[05])?)?)|(7(\.0(\.0)?)?)|(9(\.0(\.0)?)?)|(17(\.0(\.0)?)?))$")
  audit(AUDIT_VER_NOT_GRANULAR, app_name, port, version);

fix = FALSE; # Fixed version for compare
min = FALSE; # Min version for branch
pck = FALSE; # Fix pack name (tacked onto fix in report)
itr = FALSE; # 
if (version =~ "^7\.0\.")
{
  fix = '7.0.0.45';
  min = '7.0.0.0';
  itr = 'PI77770';
  pck = " (Fix Pack 45)";
}
else if (version =~ "^8\.0\.")
{
  fix = '8.0.0.13';
  min = '8.0.0.0';
  itr = 'PI77770';
  pck = " (Fix Pack 13)";
}
else if (version =~ "^8\.5\.")
{
  fix = '8.5.5.12';
  min = '8.5.0.0';
  itr = 'PI77770';
  pck = " (Fix Pack 12)";
}
else if (version =~ "^9\.0\.")
{
  fix = '9.0.0.4';
  min = '9.0.0.0';
  itr = 'PI77770';
  pck = " (Fix Pack 4)";
}
else if (version =~ "^17\.0\.")
{
  fix = '17.0.0.2';
  min = '17.0.0.0';
  itr = 'PI77770';
  pck = " (Fix Pack 2)";
}


if (fix && min &&
    ver_compare(ver:version, fix:fix, strict:FALSE) <  0 &&
    ver_compare(ver:version, fix:min, strict:FALSE) >= 0
)
{
  report =
    '\n  Version source    : ' + source  +
    '\n  Installed version : ' + version +
    '\n  Fixed version     : ' + fix + pck +
    '\n  Interim fixes     : ' + itr +
    '\n';
  security_report_v4(port:port, severity:SECURITY_WARNING, extra:report, xsrf:TRUE);
}
else audit(AUDIT_LISTEN_NOT_VULN, app_name, port, version);

