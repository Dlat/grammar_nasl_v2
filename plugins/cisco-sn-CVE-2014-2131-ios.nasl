#TRUSTED 8e452b3920f5161fb61a095fcf21093b2af03a51c591af165c1db137928f183d2bc1decbe3603a612be35eddde2a43ef1058d7bec0dfb4001c881727a252ef0337536b25fcde00c055a04bacc06d698b45381aea5a30a97f63517cc863ee0b7ed66f2f5877119352cdf7e9865ec98f84d40a3fa75256c2552e86417b4037eb3b91ccca1e837f2556329591880863ed074cf8d0bc525a34270a49ac350fd29e6394ef7b9291c8e8c115c56a64b1e5ac7176fd8496d19504b70ceb7f2a9a46ea10ed38a79cd0e2c1b00da7017dbf91f04d070c1117ea9589f65bf23de552e80be998b2dd826563037f4a7e011409dfce18dcac38171f31fd96a27a37d0bfa28db347837e57bbbdf8bf9d6a4a42106d9daf4c187652f9560e251972ff136a1b50b9dc745808aee537898e4f3d2e8347cbc2ebdc12b531d98bb03e995c7eef509f83ed4af18f405e1c367439245e9913b1d3c08a0248da63774b3ae4f8000f327c1e6a974e9202ffc7205cec6789e217d84987aeab191464736aafca7e36019853b899ff80f37094d57551ef478fe15f3da7aa0596e1aab81d4e9295330fc0ed043cfa343054d7ca50f5720c35672341526c91483ed870f59fc499eb2d37a938ce8406120ed76198b00ef09f8eac0cc60c15d06bc7b8191d3b7b3aca2969e6c766d51d0761d250cbbf0993521a08fe128c02ecece4c3ab465529c0029412286db966
#
# (C) Tenable Network Security, Inc.
#

include("compat.inc");

if (description)
{
  script_id(73828);
  script_version("1.5");
  script_set_attribute(attribute:"plugin_modification_date", value:"2017/05/16");

  script_cve_id("CVE-2014-2131");
  script_bugtraq_id(66515);
  script_osvdb_id(105076);
  script_xref(name:"CISCO-BUG-ID", value:"CSCug41049");
  script_xref(name:"CISCO-BUG-ID", value:"CSCue61890");

  script_name(english:"Cisco Catalyst 4000 Series Switch Denial of Service Vulnerability (CSCug41049 / CSCue61890)");
  script_summary(english:"Checks the IOS version.");

  script_set_attribute(attribute:"synopsis", value:"The remote device is running a vulnerable IOS version.");
  script_set_attribute(attribute:"description", value:
"The remote Cisco device potentially contains an issue which is
potentially affected by errors related to handling Virtual Switching
Systems (VSS) or Bidirectional Forwarding Detection (BFD) traffic that
could allow denial of service attacks.");
  # http://tools.cisco.com/security/center/content/CiscoSecurityNotice/CVE-2014-2131
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?854088ee");
  script_set_attribute(attribute:"see_also", value:"https://tools.cisco.com/security/center/viewAlert.x?alertId=33558");
  script_set_attribute(attribute:"solution", value:
"Upgrade to the relevant fixed version referenced in Cisco bug IDs
CSCug41049 and CSCue61890.");
  script_set_cvss_base_vector("CVSS2#AV:A/AC:M/Au:N/C:N/I:N/A:C");
  script_set_cvss_temporal_vector("CVSS2#E:ND/RL:OF/RC:C");
  script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"true");

  script_set_attribute(attribute:"plugin_type", value:"local");
  script_set_attribute(attribute:"cpe", value:"cpe:/o:cisco:ios");

  script_set_attribute(attribute:"vuln_publication_date", value:"2014/03/28");
  script_set_attribute(attribute:"patch_publication_date", value:"2014/03/28");
  script_set_attribute(attribute:"plugin_publication_date", value:"2014/05/02");

  script_end_attributes();

  script_category(ACT_GATHER_INFO);
  script_copyright(english:"This script is Copyright (C) 2014-2017 Tenable Network Security, Inc.");
  script_family(english:"CISCO");

  script_dependencies("cisco_ios_version.nasl");
  script_require_keys("Host/Cisco/IOS/Version", "Host/Cisco/IOS/Model");

  exit(0);
}

include("audit.inc");
include("cisco_func.inc");
include("cisco_kb_cmd_func.inc");

version = get_kb_item_or_exit("Host/Cisco/IOS/Version");

flag1 = 0;
flag2 = 0;

# CSCug41049
if ( version == '15.2(1)IPI2' ) flag1++;
if ( version == '15.2(1)E' ) flag1++;

# CSCue61890
if ( version == '15.2(1)IPI2' ) flag2++;

# check model
model = get_kb_item("CISCO/model");
if (model)
{
  if (model !~ "catalyst4[0-9][0-9][0-9]") audit(AUDIT_HOST_NOT, "affected");
}
else
{
  model = get_kb_item_or_exit("Host/Cisco/IOS/Model");
  if (model !~ "(^|[^0-9])4[0-9][0-9][0-9]($|[^0-9])") audit(AUDIT_HOST_NOT, "affected");
}

if (flag1 && flag2)
  fix = 'CSCug41049 and CSCue61890';
else if (flag1 && !flag2)
  fix = 'CSCug41049';
else if (!flag1 && flag2)
  fix = 'CSCue61890';

override = FALSE;

if (get_kb_item("Host/local_checks_enabled"))
{
  if (flag1 || flag2)
  {
    flag1 = 0;
    flag2 = 0;
    # Look for BFD
    buf = cisco_command_kb_item("Host/Cisco/Config/show_running-config", "show running-config");
    if (check_cisco_result(buf))
    {
      if (preg(string:buf, pattern:"bfd\s+interval\s+\d+\s+min_rx\s+\d+\s+multiplier\s+\d", multiline:TRUE)) { flag1 = 1; flag2 = 1; }
    }
    else if (cisco_needs_enable(buf)) { flag1 = 1; flag2 = 1; override = TRUE; }

    # Look for VSS
    buf2 = cisco_command_kb_item("Host/Cisco/Config/show_mod", "show mod");
    if (check_cisco_result(buf2))
    {
      if (preg(string:buf2, pattern:"Switch Number:\s+\d+\s+Role:\s+Virtual Switch Active", multiline:TRUE)) { flag1 = 1; flag2 = 1; override = FALSE; }
    }
    else if (cisco_needs_enable(buf2)) { flag1 = 1; flag2 = 1; override = TRUE; }
  }
}

if (flag1 || flag2)
{
  report =
    '\n  Cisco Bug ID        : ' + fix +
    '\n    Installed release : ' + version + '\n';

  security_warning(port:0, extra:report + cisco_caveat(override));
  exit(0);
}
else audit(AUDIT_HOST_NOT, "affected");
