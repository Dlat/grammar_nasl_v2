#TRUSTED 8a23bf7c426202051a12df889566fbe5f7e1437788f4dc71d05f1d2b382a4242f2d11534edb8782b619e17ffc80fb321a361c0174f259d3fa955081029d2e20444cd3d4fab2e81073811937b278f0a265109aded1d29574e2d81850a7e632927a5bbfd2f274cd384c59dd8f2a1e1d664ab81cc9c479645cd491abe2dd40edb63f4b231b5feca164e7522ca00d85feddf5ca2a1c6947f74be37a6c820a3af18741b306f7f55fdb73e24b17cfa9e388138307c5ca7f3c6b47c9fb92e89e69986af06df7be96fa4201e1b091591004e9f02fa7429497f688267251b8eea451623b45fe7211982f7570233878697f98d698260103b8d570c3f6ec6b841bc0dd766e8e8deb4384b47838ed7c7b0df810ec5dfc59ce053dff6fab614a77c9eddc5c274183b3ef54a68c5ad4c799d022139f6f1397b165a9108df13ae061cad08f99e4f2faf6075615818f00e64b61722e080d873d811d0999b29d6390f4f4b05bc7da98c1377b9ae5a85500784a01770ec378aaab825ccb684ebbfa9adcd013af75f60f481e7e37f1473851f5a4c6eee35b16701607b4f4720453afe5400c8473268b7f63717d9e923486042065faa5e063098c905b1c84181d5426cb50645930185b806a2baab23473b701b80c735c512e34bc3b61764ed6d34082b078bb3a86100977b9ea3dd3c1873503d660abc8d208924d145ad7ae620d672ab507b93c82439a5
#
# (C) Tenable Network Security, Inc.
#

include("compat.inc");

if (description)
{
  script_id(76881);
  script_version("1.3");
  script_set_attribute(attribute:"plugin_modification_date", value:"2017/05/16");

  script_cve_id("CVE-2014-3322");
  script_bugtraq_id(68833);
  script_osvdb_id(109456);
  script_xref(name:"CISCO-BUG-ID", value:"CSCuo68417");

  script_name(english:"Cisco IOS XR Typhoon-based Line Cards and Network Processor (NP) Chip DoS");
  script_summary(english:"Checks IOS version");

  script_set_attribute(attribute:"synopsis", value:"The remote device is missing a vendor-supplied security patch.");
  script_set_attribute(attribute:"description", value:
"The remote Cisco device is running a version Cisco IOS XR software
that is potentially affected by a denial of service vulnerability
related to Netflow and handling malformed IPv4/IPv6 packets.

Note this issue only affects Cisco ASR 9000 series devices using
Typhoon-based line cards and Netflow.");
  script_set_attribute(attribute:"see_also", value:"https://tools.cisco.com/security/center/viewAlert.x?alertId=35009");
  # http://tools.cisco.com/security/center/content/CiscoSecurityNotice/CVE-2014-3322
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?036e90f6");
  script_set_attribute(attribute:"see_also", value:"https://tools.cisco.com/bugsearch/bug/CSCuo68417");
  script_set_attribute(attribute:"solution", value:
"Apply the relevant patch referenced in Cisco Bug ID CSCuo68417.

Alternatively, disable Netflow as a workaround.");
  script_set_cvss_base_vector("CVSS2#AV:A/AC:L/Au:N/C:N/I:N/A:C");
  script_set_cvss_temporal_vector("CVSS2#E:ND/RL:OF/RC:C");
  script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"true");

  script_set_attribute(attribute:"vuln_publication_date", value:"2014/07/22");
  script_set_attribute(attribute:"patch_publication_date", value:"2014/07/22");
  script_set_attribute(attribute:"plugin_publication_date", value:"2014/07/29");

  script_set_attribute(attribute:"plugin_type", value:"local");
  script_set_attribute(attribute:"cpe", value:"cpe:/o:cisco:ios_xr");
  script_end_attributes();

  script_category(ACT_GATHER_INFO);
  script_copyright(english:"This script is (C) 2014-2017 Tenable Network Security, Inc.");
  script_family(english:"CISCO");

  script_dependencies("cisco_ios_xr_version.nasl");
  script_require_keys("Host/Cisco/IOS-XR/Version");

  exit(0);
}

include("audit.inc");
include("cisco_func.inc");
include("cisco_kb_cmd_func.inc");

# check model
model = get_kb_item("CISCO/model");
if (model)
{
  if (model !~ "ciscoASR9[0-9]{3}") audit(AUDIT_HOST_NOT, "ASR 9000 series");
}
else
{
  model = get_kb_item_or_exit("Host/Cisco/IOS-XR/Model");
  if ("ASR9K" >!< model) audit(AUDIT_HOST_NOT, "ASR 9000 series");
}

version = get_kb_item_or_exit("Host/Cisco/IOS-XR/Version");

# Affected per vendor :
# 4.3 .0, .1, .2
# and
# 4.3.4.BASE
if (version !~ "^4\.3\.[0124]($|[^0-9])") audit(AUDIT_HOST_NOT, "affected");

override = FALSE;

if (get_kb_item("Host/local_checks_enabled"))
{
  flag = FALSE;

  buf = cisco_command_kb_item("Host/Cisco/Config/show_running-config", "show running-config");
  # If Netflow is enabled, contents will be similar to :
  # flow exporter-map {map-name}
  # else, flow is not displayed
  if (check_cisco_result(buf))
  {
    if ("flow exporter-map " >< buf) flag = TRUE;
    else audit(AUDIT_HOST_NOT, "affected because Netflow is not enabled");

    # Next check for Typhoon card(s)
    buf = cisco_command_kb_item("Host/Cisco/Config/show_module", "show module");
    if (check_cisco_result(buf))
    {
      if (
        "A9K-MOD80-SE"   >< buf ||
        "A9K-MOD80-TR"   >< buf ||
        "A9K-MOD160-SE"  >< buf ||
        "A9K-MOD160-TR"  >< buf ||
        "A9K-24X10GE-SE" >< buf ||
        "A9K-24X10GE-TR" >< buf ||
        "A9K-36X10GE-SE" >< buf ||
        "A9K-36X10GE-TR" >< buf ||
        "A9K-2X100GE-SE" >< buf ||
        "A9K-2X100GE-TR" >< buf ||
        "A9K-1X100GE-SE" >< buf ||
        "A9K-1X100GE-TR" >< buf
      ) flag = TRUE;
      else audit(AUDIT_HOST_NOT, "affected because it does not contain a Typhoon-based card.");
    }
    else if (cisco_needs_enable(buf)) override = TRUE;
  }
  else if (cisco_needs_enable(buf)) override = TRUE;

  if (!flag && !override) audit(AUDIT_HOST_NOT, "affected");
}

if (report_verbosity > 0)
{
  report =
    '\n  Cisco Bug ID      : CSCuo68417' +
    '\n  Installed release : ' + version + 
    '\n';
  security_warning(port:0, extra:report+cisco_caveat(override));
}
else security_warning(port:0, extra:cisco_caveat(override));
